<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>éœ“è™¹è·³è·ƒ | Neon Jump</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a2a;overflow:hidden;font-family:'Segoe UI',sans-serif;touch-action:none}
canvas{display:block;position:fixed;top:0;left:0;z-index:1}
#ui{position:fixed;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none}
#hud{position:absolute;top:12px;left:0;width:100%;display:flex;justify-content:space-between;padding:0 20px;font-size:20px;font-weight:bold}
#sc-box{color:#0ff}
#lv-box{color:#f0f}
#combo-box{position:absolute;top:25%;left:50%;transform:translate(-50%,-50%);font-size:48px;font-weight:900;color:#ff0;opacity:0;transition:opacity 0.3s}
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:auto}
#menu{background:radial-gradient(ellipse at center,#1a0a3e,#0a0a2a)}
#gameover,#winscreen{background:rgba(10,10,30,0.95);display:none}
h1{font-size:60px;font-weight:900;background:linear-gradient(135deg,#0ff,#f0f,#ff0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.sub{color:#888;font-size:16px;margin-bottom:30px}
button{padding:14px 40px;font-size:18px;border:2px solid #0ff;background:transparent;color:#0ff;border-radius:30px;cursor:pointer;margin:8px;pointer-events:auto}
button:hover{background:#0ff;color:#000}
.pink{border-color:#f0f;color:#f0f}
.pink:hover{background:#f0f;color:#000}
.big{font-size:50px;font-weight:900;margin-bottom:10px}
.info{color:#ccc;font-size:18px;margin-bottom:20px}
.hint{position:absolute;bottom:20px;color:#555;font-size:13px}
#mctrl{position:fixed;bottom:16px;left:0;width:100%;display:none;justify-content:space-between;padding:0 16px;z-index:20;pointer-events:auto}
.mb{width:70px;height:70px;border-radius:50%;border:2px solid rgba(0,255,255,0.5);background:rgba(0,255,255,0.15);color:#0ff;font-size:28px;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-tap-highlight-color:transparent}
.mb:active{background:rgba(0,255,255,0.4)}
#mbj{border-color:rgba(255,0,255,0.5);background:rgba(255,0,255,0.15);color:#f0f;font-size:16px;font-weight:bold;width:80px;height:80px}
@media(max-width:900px){#mctrl{display:flex}}
</style>
</head>
<body>
<canvas id="gc"></canvas>
<div id="ui">
  <div id="hud"><div id="sc-box">âš¡ 0</div><div id="lv-box">å…³å¡ 1/5</div></div>
  <div id="combo-box"></div>
  <div id="menu" class="screen">
    <h1>éœ“è™¹è·³è·ƒ</h1>
    <div class="sub">åœ¨éœ“è™¹ç¯å…‰ä¸­è·ƒå‘å·…å³°</div>
    <button onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
    <div class="hint">âŒ¨ï¸ æ–¹å‘é”®/WASD ç§»åŠ¨è·³è·ƒ Â· æ‰‹æœºè§¦å±</div>
  </div>
  <div id="gameover" class="screen">
    <div class="big" style="color:#f44">ğŸ’€ å è½äº†</div>
    <div class="info">åˆ«ç°å¿ƒï¼Œå†è¯•ä¸€æ¬¡</div>
    <button class="pink" onclick="retry()">é‡æ–°æŒ‘æˆ˜</button>
  </div>
  <div id="winscreen" class="screen">
    <div class="big" style="color:#ff0">ğŸ‰ é€šå…³!</div>
    <div class="info">æ€»åˆ†: <span id="fscore">0</span></div>
    <button onclick="startGame()">å†æ¥ä¸€æ¬¡</button>
  </div>
</div>
<div id="mctrl">
  <div class="mb" id="ml">â—€</div>
  <div class="mb" id="mbj">è·³</div>
  <div class="mb" id="mr">â–¶</div>
</div>
<script>
var cv = document.getElementById('gc');
var ctx = cv.getContext('2d');
var W, H;

function resize() {
  W = cv.width = window.innerWidth;
  H = cv.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// Audio System
var audioCtx = null;
var masterGain = null;
var bgmPlaying = false;
var bgmTimer = null;

function initAudio() {
  if (!audioCtx) {
    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = 0.5;
      masterGain.connect(audioCtx.destination);
    } catch(e) {}
  }
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}

function playNote(freq, dur, type, vol, delay) {
  if (!audioCtx) return;
  try {
    var t = audioCtx.currentTime + (delay || 0);
    var o = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    o.type = type || 'sine';
    o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(vol || 0.08, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    o.connect(g); g.connect(masterGain);
    o.start(t); o.stop(t + dur);
  } catch(e) {}
}

function playSweep(f1, f2, dur, type, vol) {
  if (!audioCtx) return;
  try {
    var t = audioCtx.currentTime;
    var o = audioCtx.createOscillator();
    var g = audioCtx.createGain();
    o.type = type || 'sine';
    o.frequency.setValueAtTime(f1, t);
    o.frequency.exponentialRampToValueAtTime(f2, t + dur);
    g.gain.setValueAtTime(vol || 0.08, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    o.connect(g); g.connect(masterGain);
    o.start(t); o.stop(t + dur);
  } catch(e) {}
}

function playNoise(dur, vol) {
  if (!audioCtx) return;
  try {
    var t = audioCtx.currentTime;
    var bufSize = audioCtx.sampleRate * dur;
    var buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
    var data = buf.getChannelData(0);
    for (var i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1);
    var src = audioCtx.createBufferSource();
    src.buffer = buf;
    var g = audioCtx.createGain();
    g.gain.setValueAtTime(vol || 0.05, t);
    g.gain.exponentialRampToValueAtTime(0.001, t + dur);
    var filt = audioCtx.createBiquadFilter();
    filt.type = 'lowpass';
    filt.frequency.value = 800;
    src.connect(filt); filt.connect(g); g.connect(masterGain);
    src.start(t); src.stop(t + dur);
  } catch(e) {}
}

// Sound effects
var sfx = {
  jump: function() {
    playSweep(320, 680, 0.15, 'sine', 0.1);
    playSweep(160, 340, 0.12, 'triangle', 0.04);
  },
  land: function() {
    playNoise(0.06, 0.08);
    playNote(100, 0.08, 'sine', 0.06);
  },
  coin: function(comboN) {
    var base = 660 + Math.min(comboN, 10) * 60;
    playNote(base, 0.08, 'square', 0.06);
    playNote(base * 1.25, 0.1, 'sine', 0.08, 0.06);
    playNote(base * 1.5, 0.15, 'sine', 0.06, 0.12);
  },
  comboHit: function(n) {
    var base = 500 + n * 80;
    playSweep(base, base * 1.5, 0.2, 'square', 0.05);
    playNote(base * 1.5, 0.15, 'sine', 0.07, 0.1);
  },
  die: function() {
    playSweep(500, 80, 0.5, 'sawtooth', 0.12);
    playNoise(0.4, 0.1);
    playNote(80, 0.6, 'sine', 0.08, 0.1);
  },
  spike: function() {
    playSweep(900, 100, 0.3, 'square', 0.1);
    playNoise(0.25, 0.12);
    playNote(60, 0.4, 'triangle', 0.08);
  },
  levelUp: function() {
    var notes = [523, 659, 784, 1047];
    for (var i = 0; i < notes.length; i++) {
      playNote(notes[i], 0.3, 'sine', 0.08, i * 0.1);
      playNote(notes[i] * 0.5, 0.3, 'triangle', 0.04, i * 0.1);
    }
    playNoise(0.08, 0.04);
  },
  win: function() {
    var melody = [523, 659, 784, 1047, 784, 1047, 1319, 1568];
    for (var i = 0; i < melody.length; i++) {
      playNote(melody[i], 0.35, 'sine', 0.07, i * 0.12);
      playNote(melody[i] * 0.75, 0.35, 'triangle', 0.04, i * 0.12);
    }
    setTimeout(function() {
      playNote(1568, 0.8, 'sine', 0.1);
      playNote(1175, 0.8, 'sine', 0.06);
      playNote(784, 0.8, 'triangle', 0.05);
    }, melody.length * 120);
  },
  menuClick: function() {
    playNote(800, 0.06, 'square', 0.06);
    playNote(1200, 0.1, 'sine', 0.08, 0.04);
  }
};

// Background music - procedural beat
var bgmStep = 0;
var bgmBPM = 140;
var bgmPattern = [1,0,0,1, 0,1,0,0, 1,0,1,0, 0,0,1,0];
var bgmBass =    [130,0,0,130, 0,165,0,0, 175,0,130,0, 0,0,165,0];
var bgmMelody =  [0,0,523,0, 0,0,659,0, 0,0,784,0, 659,0,0,0];

function bgmTick() {
  if (state !== 'play' || !audioCtx) return;
  var idx = bgmStep % 16;

  // Kick drum
  if (bgmPattern[idx]) {
    playSweep(150, 40, 0.1, 'sine', 0.1);
    playNoise(0.04, 0.04);
  }
  // Hi-hat on off-beats
  if (idx % 2 === 1) {
    playNoise(0.03, 0.02);
  }
  // Bass
  if (bgmBass[idx]) {
    playNote(bgmBass[idx], 0.12, 'triangle', 0.06);
  }
  // Melody (quiet, atmospheric)
  if (bgmMelody[idx] && Math.random() < 0.6) {
    playNote(bgmMelody[idx], 0.2, 'sine', 0.025);
  }

  bgmStep++;
}

function startBGM() {
  if (bgmPlaying) return;
  bgmPlaying = true;
  bgmStep = 0;
  var interval = 60000 / bgmBPM / 4; // 16th notes
  bgmTimer = setInterval(bgmTick, interval);
}

function stopBGM() {
  bgmPlaying = false;
  if (bgmTimer) { clearInterval(bgmTimer); bgmTimer = null; }
}

// Legacy beep for compatibility
function beep(freq, dur, type, vol) {
  playNote(freq, dur, type, vol);
}

// Input
var keys = {};
var ml = 0, mr = 0, mj = 0;
window.addEventListener('keydown', function(e) {
  keys[e.code] = true;
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].indexOf(e.code) >= 0) e.preventDefault();
});
window.addEventListener('keyup', function(e) { keys[e.code] = false; });

function touchBind(id, cb) {
  var el = document.getElementById(id);
  el.addEventListener('touchstart', function(e) { e.preventDefault(); cb(1); }, {passive:false});
  el.addEventListener('touchend', function(e) { e.preventDefault(); cb(0); }, {passive:false});
  el.addEventListener('mousedown', function(e) { cb(1); });
  el.addEventListener('mouseup', function(e) { cb(0); });
}
touchBind('ml', function(v){ml=v});
touchBind('mr', function(v){mr=v});
touchBind('mbj', function(v){mj=v});

// Game state
var state = 'menu'; // menu, play, dead, won
var score = 0, level = 1, combo = 0;
var camY = 0, shake = 0;
var player, platforms, coins, spikes, goalStar, particles;

var themes = [
  {bg:'#0a0a2a', plat:'#00e5ff', accent:'#ff00ff'},
  {bg:'#0a1a0a', plat:'#00ff88', accent:'#ffee00'},
  {bg:'#1a0a0a', plat:'#ff5555', accent:'#ff8800'},
  {bg:'#0a0a3e', plat:'#8888ff', accent:'#ff44ff'},
  {bg:'#1a1a00', plat:'#ffdd00', accent:'#00ffff'}
];

// Stars background
var stars = [];
for (var i = 0; i < 120; i++) {
  stars.push({x: Math.random() * 2000, y: Math.random() * 12000, s: Math.random() * 2 + 0.5});
}

// Particles
function addParticle(x, y, vx, vy, color, life) {
  particles.push({x:x, y:y, vx:vx, vy:vy, color:color, life:life, max:life, sz: 2 + Math.random()*3});
}
function burst(x, y, n, speed, color, life) {
  for (var i = 0; i < n; i++) {
    var a = Math.random() * Math.PI * 2;
    var s = speed * (0.3 + Math.random() * 0.7);
    addParticle(x, y, Math.cos(a)*s, Math.sin(a)*s, color, life * (0.5 + Math.random()*0.5));
  }
}

function generateLevel(lv) {
  platforms = [];
  coins = [];
  spikes = [];
  particles = [];
  goalStar = null;

  // Ground - very visible, full width, thick
  platforms.push({x: 0, y: H - 50, w: W, h: 50, ground: true, moving: false});

  // Player starts on ground
  player = {
    x: W/2 - 16, y: H - 50 - 36, w: 32, h: 36,
    vx: 0, vy: 0, onGround: false, jumpBuffer: 0, coyoteTime: 0,
    face: 1, trail: []
  };

  var platCount = 8 + lv * 3;
  var curY = H - 50;
  var curX = W / 2;

  for (var i = 0; i < platCount; i++) {
    var pw = 80 + Math.random() * 50;
    curY -= 60 + Math.random() * 20;
    curX += (Math.random() - 0.5) * 200;
    curX = Math.max(20, Math.min(W - pw - 20, curX));

    var isMoving = lv >= 3 && i > 3 && Math.random() < 0.2;
    var p = {x: curX, y: curY, w: pw, h: 16, ground: false, moving: isMoving};
    if (isMoving) {
      p.baseX = curX;
      p.range = 30 + Math.random() * 40;
      p.speed = 0.8 + Math.random() * 0.5;
      p.phase = Math.random() * 6.28;
    }
    platforms.push(p);

    // Coins
    if (Math.random() < 0.5) {
      coins.push({x: curX + pw/2, y: curY - 24, collected: false, phase: Math.random() * 6.28});
    }

    // Spikes from level 2
    if (lv >= 2 && i > 2 && Math.random() < 0.1) {
      var sw = pw * 0.3;
      spikes.push({x: curX + (pw - sw)/2, y: curY - 12, w: sw, h: 12});
    }
  }

  // Goal star at top
  goalStar = {x: curX + 40, y: curY - 60};
  camY = 0;
  combo = 0;
}

function updateGame(dt) {
  if (!player) return;

  var SPEED = 280, ACCEL = 1500, FRICTION = 0.82, GRAVITY = 1100, JUMP_VEL = -480;

  // Input
  var ix = 0;
  if (keys.ArrowLeft || keys.KeyA || ml) ix = -1;
  if (keys.ArrowRight || keys.KeyD || mr) ix = 1;
  if (ix !== 0) player.face = ix;

  // Horizontal movement
  player.vx += ix * ACCEL * dt;
  player.vx *= Math.pow(FRICTION, dt * 60);
  if (Math.abs(player.vx) > SPEED) player.vx = Math.sign(player.vx) * SPEED;
  if (ix === 0 && Math.abs(player.vx) < 8) player.vx = 0;

  // Jump
  var wantJump = keys.ArrowUp || keys.KeyW || keys.Space || mj;
  if (wantJump && player.jumpBuffer <= 0) player.jumpBuffer = 0.12;
  if (!wantJump) player.jumpBuffer = 0;
  else player.jumpBuffer -= dt;

  if (player.onGround) player.coyoteTime = 0.1;
  else player.coyoteTime -= dt;

  if (player.jumpBuffer > 0 && player.coyoteTime > 0) {
    player.vy = JUMP_VEL;
    player.jumpBuffer = 0;
    player.coyoteTime = 0;
    sfx.jump();
    burst(player.x + player.w/2, player.y + player.h, 5, 80, '#fff', 0.4);
  }

  // Gravity
  player.vy += GRAVITY * dt;
  if (player.vy > 700) player.vy = 700;

  // Move
  player.x += player.vx * dt;
  player.y += player.vy * dt;

  // Platform collision
  player.onGround = false;
  for (var i = 0; i < platforms.length; i++) {
    var p = platforms[i];
    if (p.moving) {
      p.phase += p.speed * dt;
      p.x = p.baseX + Math.sin(p.phase) * p.range;
    }
    if (player.vy >= 0 &&
        player.x + player.w > p.x + 4 &&
        player.x < p.x + p.w - 4 &&
        player.y + player.h >= p.y &&
        player.y + player.h <= p.y + 18) {
      player.y = p.y - player.h;
      player.vy = 0;
      if (!player.onGround) sfx.land();
      player.onGround = true;
    }
  }

  // Screen wrap
  if (player.x + player.w < 0) player.x = W;
  if (player.x > W) player.x = -player.w;

  // Trail
  player.trail.push({x: player.x, y: player.y, a: 0.5});
  if (player.trail.length > 8) player.trail.shift();
  for (var i = 0; i < player.trail.length; i++) player.trail[i].a *= 0.75;

  // Camera - follow player up
  var targetCam = Math.min(0, player.y - H * 0.45);
  camY += (targetCam - camY) * 0.08;

  // Death check - fell below visible area
  if (player.y - camY > H + 120) {
    state = 'dead';
    sfx.die();
    stopBGM();
    shake = 15;
    burst(player.x + player.w/2, player.y + player.h/2, 25, 120, themes[level-1].accent, 1);
    setTimeout(function() {
      document.getElementById('gameover').style.display = 'flex';
    }, 400);
    return;
  }

  // Coins
  for (var i = coins.length - 1; i >= 0; i--) {
    var c = coins[i];
    if (c.collected) continue;
    var dx = player.x + player.w/2 - c.x;
    var dy = player.y + player.h/2 - c.y;
    if (dx*dx + dy*dy < 800) {
      c.collected = true;
      combo++;
      score += 10 * combo;
      sfx.coin(combo);
      if (combo > 2) sfx.comboHit(combo);
      shake = 4;
      burst(c.x, c.y, 8, 100, '#ff0', 0.6);
      if (combo > 1) {
        var cb = document.getElementById('combo-box');
        cb.textContent = combo + 'x è¿å‡»!';
        cb.style.opacity = 1;
        setTimeout(function(){cb.style.opacity=0}, 700);
      }
    }
  }

  // Spikes
  for (var i = 0; i < spikes.length; i++) {
    var s = spikes[i];
    if (player.x + player.w > s.x + 2 && player.x < s.x + s.w - 2 &&
        player.y + player.h > s.y + 2 && player.y < s.y + s.h) {
      state = 'dead';
      sfx.spike();
      stopBGM();
      shake = 15;
      burst(player.x + player.w/2, player.y + player.h/2, 25, 120, '#f44', 1);
      setTimeout(function() {
        document.getElementById('gameover').style.display = 'flex';
      }, 400);
      return;
    }
  }

  // Goal
  if (goalStar) {
    var dx = player.x + player.w/2 - goalStar.x;
    var dy = player.y + player.h/2 - goalStar.y;
    if (dx*dx + dy*dy < 2500) {
      if (level < 5) {
        // Next level
        sfx.levelUp();
        level++;
        score += 50;
        burst(player.x + player.w/2, player.y + player.h/2, 30, 150, themes[level-1].plat, 1);
        generateLevel(level);
        state = 'play';
      } else {
        // Win!
        state = 'won';
        score += 100;
        shake = 20;
        sfx.win();
        stopBGM();
        burst(player.x+player.w/2, player.y+player.h/2, 50, 200, '#ff0', 2);
        document.getElementById('fscore').textContent = score;
        setTimeout(function() {
          document.getElementById('winscreen').style.display = 'flex';
        }, 800);
      }
    }
  }

  // Update HUD
  document.getElementById('sc-box').textContent = 'âš¡ ' + score;
  document.getElementById('lv-box').textContent = 'å…³å¡ ' + level + '/5';
}

function drawGame(dt) {
  var th = themes[level - 1];
  var t = performance.now() / 1000;

  // Background
  ctx.fillStyle = th.bg;
  ctx.fillRect(0, 0, W, H);

  // Stars
  ctx.fillStyle = '#fff';
  for (var i = 0; i < stars.length; i++) {
    var s = stars[i];
    var sx = s.x % W;
    var sy = ((s.y - camY * 0.15) % H + H) % H;
    ctx.globalAlpha = 0.2 + Math.sin(t * 0.5 + i) * 0.15;
    ctx.fillRect(sx, sy, s.s, s.s);
  }
  ctx.globalAlpha = 1;

  // Grid lines
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  for (var x = 0; x < W; x += 60) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  var gridOff = ((-camY * 0.3) % 60 + 60) % 60;
  for (var y = gridOff; y < H; y += 60) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // Draw platforms
  for (var i = 0; i < platforms.length; i++) {
    var p = platforms[i];
    var drawY = p.y - camY;
    if (drawY > H + 60 || drawY < -60) continue;

    if (p.ground) {
      // Ground: bright solid bar
      ctx.fillStyle = th.plat;
      ctx.fillRect(p.x, drawY, p.w, p.h);
      // Glow on top
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.fillRect(p.x, drawY, p.w, 3);
      // Bottom gradient
      ctx.fillStyle = 'rgba(0,0,0,0.3)';
      ctx.fillRect(p.x, drawY + p.h - 6, p.w, 6);
    } else {
      // Regular platform with glow
      ctx.shadowColor = th.plat;
      ctx.shadowBlur = 12;
      ctx.fillStyle = th.plat;
      ctx.fillRect(p.x, drawY, p.w, p.h);
      ctx.shadowBlur = 0;
      // Highlight
      ctx.fillStyle = 'rgba(255,255,255,0.35)';
      ctx.fillRect(p.x + 3, drawY + 1, p.w - 6, 3);
      // Moving indicator
      if (p.moving) {
        ctx.fillStyle = th.accent;
        ctx.fillRect(p.x + p.w/2 - 5, drawY + 4, 10, p.h - 6);
      }
    }
  }

  // Spikes
  ctx.fillStyle = '#ff3333';
  for (var i = 0; i < spikes.length; i++) {
    var s = spikes[i];
    var sy = s.y - camY;
    if (sy > H + 20 || sy < -20) continue;
    var count = Math.floor(s.w / 10);
    for (var j = 0; j < count; j++) {
      var tx = s.x + j * (s.w / count) + s.w / count / 2;
      ctx.beginPath();
      ctx.moveTo(tx - 5, sy + s.h);
      ctx.lineTo(tx, sy);
      ctx.lineTo(tx + 5, sy + s.h);
      ctx.fill();
    }
  }

  // Coins
  for (var i = 0; i < coins.length; i++) {
    var c = coins[i];
    if (c.collected) continue;
    var cy = c.y - camY + Math.sin(t * 3 + c.phase) * 5;
    if (cy > H + 20 || cy < -20) continue;
    ctx.fillStyle = '#ffdd00';
    ctx.shadowColor = '#ffdd00';
    ctx.shadowBlur = 10;
    ctx.beginPath(); ctx.arc(c.x, cy, 9, 0, Math.PI * 2); ctx.fill();
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#cc8800';
    ctx.beginPath(); ctx.arc(c.x, cy, 4, 0, Math.PI * 2); ctx.fill();
  }

  // Goal star
  if (goalStar) {
    var gy = goalStar.y - camY;
    if (gy > -60 && gy < H + 60) {
      var pulse = 0.6 + Math.sin(t * 4) * 0.4;
      ctx.save();
      ctx.translate(goalStar.x, gy);
      ctx.rotate(t * 0.5);
      ctx.fillStyle = 'rgba(255,238,0,' + (0.6 + pulse * 0.4) + ')';
      ctx.shadowColor = '#ffee00';
      ctx.shadowBlur = 25;
      ctx.beginPath();
      for (var i = 0; i < 5; i++) {
        var a1 = Math.PI * 2 / 5 * i - Math.PI / 2;
        var a2 = a1 + Math.PI / 5;
        ctx.lineTo(Math.cos(a1) * 22, Math.sin(a1) * 22);
        ctx.lineTo(Math.cos(a2) * 10, Math.sin(a2) * 10);
      }
      ctx.closePath();
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.restore();
      // Label
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(level < 5 ? 'â–² NEXT' : 'â˜… GOAL', goalStar.x, gy - 32);
    }
  }

  // Player
  if (player && (state === 'play' || state === 'dead')) {
    // Trail
    for (var i = 0; i < player.trail.length; i++) {
      var tr = player.trail[i];
      ctx.globalAlpha = tr.a * 0.2;
      ctx.fillStyle = th.accent;
      ctx.fillRect(tr.x, tr.y - camY, player.w, player.h);
    }
    ctx.globalAlpha = 1;

    if (state === 'play') {
      var px = player.x;
      var py = player.y - camY;
      // Body
      ctx.fillStyle = th.accent;
      ctx.shadowColor = th.accent;
      ctx.shadowBlur = 14;
      ctx.fillRect(px, py, player.w, player.h);
      ctx.shadowBlur = 0;
      // Eyes
      ctx.fillStyle = '#000';
      var ex = player.face * 3;
      ctx.fillRect(px + 8 + ex, py + 10, 5, 6);
      ctx.fillRect(px + 19 + ex, py + 10, 5, 6);
      // Mouth
      ctx.fillRect(px + 12 + ex, py + 22, 8, 3);
    }
  }

  // Particles
  for (var i = particles.length - 1; i >= 0; i--) {
    var p = particles[i];
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vy += 200 * dt;
    p.life -= dt;
    if (p.life <= 0) { particles.splice(i, 1); continue; }
    var alpha = p.life / p.max;
    ctx.globalAlpha = alpha;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x - p.sz/2, p.y - camY - p.sz/2, p.sz, p.sz);
  }
  ctx.globalAlpha = 1;
}

// Main loop
var lastTime = 0;
function gameLoop(ts) {
  var dt = Math.min((ts - lastTime) / 1000, 0.05);
  lastTime = ts;

  if (state === 'play') updateGame(dt);

  // Shake
  var sx = 0, sy = 0;
  if (shake > 0) {
    sx = (Math.random() - 0.5) * shake;
    sy = (Math.random() - 0.5) * shake;
    shake *= 0.88;
    if (shake < 0.3) shake = 0;
  }

  ctx.save();
  ctx.translate(sx, sy);
  drawGame(dt);
  ctx.restore();

  // Menu particles
  if (state === 'menu' && particles && Math.random() < 0.06) {
    addParticle(Math.random()*W, H+5, (Math.random()-0.5)*40, -(60+Math.random()*80),
      ['#0ff','#f0f','#ff0'][Math.floor(Math.random()*3)], 2.5);
  }
  // Win fireworks
  if (state === 'won' && particles && Math.random() < 0.15) {
    burst(Math.random()*W, Math.random()*H*0.6, 10, 120,
      ['#ff0','#f0f','#0ff','#0f0','#f44'][Math.floor(Math.random()*5)], 1);
  }

  requestAnimationFrame(gameLoop);
}

// Start
function startGame() {
  initAudio();
  sfx.menuClick();
  document.getElementById('menu').style.display = 'none';
  document.getElementById('gameover').style.display = 'none';
  document.getElementById('winscreen').style.display = 'none';
  score = 0; level = 1; combo = 0;
  particles = [];
  generateLevel(1);
  state = 'play';
  startBGM();
}

function retry() {
  sfx.menuClick();
  document.getElementById('gameover').style.display = 'none';
  combo = 0;
  generateLevel(level);
  state = 'play';
  startBGM();
}

// Init particles for menu
particles = [];
requestAnimationFrame(gameLoop);
</script>
</body>
</html>